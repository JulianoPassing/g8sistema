<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>G8 Representa√ß√µes - BKB</title>
    <link rel="icon" href="https://i.imgur.com/WveVVY5.png" type="image/png" />
    <link rel="apple-touch-icon" href="https://i.imgur.com/WveVVY5.png" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
      <link rel="stylesheet" href="modern-design.css">
      <link rel="stylesheet" href="mobile.css">
      <link rel="stylesheet" href="connection-status.css">
    <script src="advanced-notifications.js"></script>
    <script src="animations.js"></script>
    <script src="offline-system.js"></script>
    <script src="connection-monitor.js"></script>

    <style>
      :root {
        /* === CORES G8 === */
        --g8-red: #ff0000;
        --g8-black: #000000;
        --g8-white: #ffffff;
        
        --primary-color: #ff0000;
        --primary-hover: #cc0000;
        --secondary-color: #000000;
        --success-color: #059669;
        --success-hover: #047857;
        --danger-color: #dc2626;
        --danger-hover: #b91c1c;
        --warning-color: #d97706;
        --warning-hover: #b45309;
        --light-color: #ffffff;
        --dark-color: #000000;
        --text-color: #000000;
        --text-muted: #666666;
        --bg-color: #ffffff;
        --card-bg: #fafafa;
        --border-color: #e0e0e0;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --shadow-red: 0 10px 40px rgba(255, 0, 0, 0.25);
        --border-radius: 8px;
        --border-radius-lg: 12px;
        --border-radius-xl: 16px;
        --gradient-primary: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
        --gradient-secondary: linear-gradient(135deg, #000000 0%, #333333 100%);
        --gradient-success: linear-gradient(135deg, #059669 0%, #047857 100%);
        --gradient-danger: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        --gradient-dark: linear-gradient(135deg, #1e293b 0%, #000000 100%);
        --gradient-bg: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: var(--text-color);
        background: var(--bg-color);
        margin: 0;
        padding: 80px 20px 0 20px;
        font-size: 14px;
        min-height: 100vh;
        position: relative;
        display: flex;
        flex-direction: column;
      }

      /* Fundo animado sutil */
      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: 
          radial-gradient(circle at 20% 80%, rgba(255, 0, 0, 0.05) 0%, transparent 50%),
          radial-gradient(circle at 80% 20%, rgba(0, 0, 0, 0.08) 0%, transparent 50%),
          radial-gradient(circle at 40% 40%, rgba(255, 0, 0, 0.03) 0%, transparent 50%);
        animation: backgroundFloat 25s ease-in-out infinite;
        z-index: -1;
      }

      @keyframes backgroundFloat {
        0%, 100% { transform: translateX(0) translateY(0); }
        50% { transform: translateX(-15px) translateY(15px); }
      }

      /* --- HEADER CORRIGIDO --- */
      .header-top {
        width: 100%;
        position: absolute;
        top: 0;
        left: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 25px;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        box-shadow: var(--shadow);
        z-index: 1000;
        border-bottom: 1px solid var(--border-color);
        height: 70px;
        box-sizing: border-box;
      }

      .header-left {
        flex: 0 0 auto;
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .header-center {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
      }

      .header-center img {
        height: 45px;
        width: auto;
      }

      .header-right {
        flex: 0 0 auto;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      #user-info {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        font-size: 0.9rem;
        color: var(--text-color);
        font-weight: 500;
      }

      #logout-button, .btn {
        background: var(--gradient-primary);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-sm);
      }

      #logout-button:hover, .btn:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        flex: 1;
      }

      /* Caixa de rolagem para produtos */
      #produtos-container {
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 25px;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow);
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        padding: 12px 0;
        transition: all 0.3s ease;
      }

      #produtos-container:hover {
        box-shadow: var(--shadow-lg);
      }

      /* Estiliza√ß√£o da barra de rolagem */
      #produtos-container::-webkit-scrollbar {
        width: 8px;
      }

      #produtos-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      #produtos-container::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 4px;
      }

      #produtos-container::-webkit-scrollbar-thumb:hover {
        background: var(--primary-hover);
      }

      /* CSS para hover nas linhas da tabela */
      tbody tr:hover {
        background-color: #f5f5f5;
      }

      /* Espa√ßamento entre produtos na tabela */
      tbody tr {
        border-bottom: 1px solid #e9ecef;
        height: 50px;
      }

      tbody tr td {
        padding: 12px 8px;
        vertical-align: middle;
      }

      /* CSS para bot√µes */
      .btn {
        display: inline-block;
        padding: 8px 16px;
        margin-bottom: 0;
        font-size: 14px;
        font-weight: 400;
        line-height: 1.42857143;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        cursor: pointer;
        border: 1px solid transparent;
        border-radius: 4px;
        text-decoration: none;
        transition: all 0.3s ease;
      }

      .btn-sm {
        padding: 5px 10px;
        font-size: 12px;
        line-height: 1.5;
        border-radius: 3px;
      }

      .btn-success {
        background-color: var(--success-color);
        color: white;
        border-color: var(--success-color);
      }

      .btn-success:hover {
        background-color: var(--success-hover);
        border-color: var(--success-hover);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .btn-danger {
        background-color: var(--danger-color);
        color: white;
        border-color: var(--danger-color);
        padding: 5px 10px;
        font-size: 0.85em;
      }

      .btn-danger:hover {
        background-color: var(--danger-hover);
        border-color: var(--danger-hover);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .card {
        background: var(--card-bg);
        border-radius: var(--border-radius-lg);
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
      }

      .card:hover {
        box-shadow: var(--shadow-lg);
      }

      .card-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--border-color);
      }

      .card-header h2 {
        color: var(--text-color);
        font-size: 1.5rem;
        font-weight: 600;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        margin-bottom: 12px;
      }

      .form-grid .form-group {
        margin-bottom: 0;
      }

      .form-group.full-width {
        grid-column: 1 / -1;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: var(--text-color);
      }

      .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        font-size: 14px;
        transition: all 0.3s ease;
        background: white;
      }

      .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(255, 0, 0, 0.1);
      }

      .btn-primary {
        background: var(--gradient-primary);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary:hover {
        background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      /* Rodap√© G8 */
      footer {
        width: 100%;
        text-align: center;
        padding: 15px 20px;
        background: transparent;
        color: #000000;
        margin-top: 40px;
        position: relative;
        font-size: 0.85rem;
        font-weight: 500;
      }

      /* CSS para sugest√µes de clientes e produtos */
      #sugestoes-clientes,
      #sugestoes-produtos {
        position: absolute;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-height: 300px;
        overflow-y: auto;
        width: 100%;
        z-index: 1001;
        margin-top: 2px;
        padding: 0;
        display: none;
      }
      .sugestao-cliente-item {
        padding: 10px 16px;
        cursor: pointer;
        font-size: 1em;
        background: #fff;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.18s;
        color: #222;
        line-height: 1.3;
        display: block;
      }
      .sugestao-cliente-item:last-child {
        border-bottom: none;
      }
      .sugestao-cliente-item:hover {
        background: #f3f7fa;
        color: #007bff;
      }
      #busca-cliente {
        width: 100%;
        box-sizing: border-box;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        padding: 10px 12px;
        font-size: 1em;
        margin-bottom: 6px;
      }

      /* Estilos espec√≠ficos para inputs em tabelas */
      input[type="text"],
      input[type="number"],
      input[type="email"],
      select,
      textarea {
        width: 100%;
        padding: 10px 12px;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        font-size: 0.9rem;
        transition: all 0.3s ease;
        background: var(--card-bg);
        color: var(--text-color);
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        transform: translateY(-1px);
      }

      input::placeholder,
      textarea::placeholder {
        color: var(--text-muted);
        font-weight: 400;
      }

      /* Estilos profissionais para se√ß√£o "Seu Pedido" */
      .pedido-item {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: 1px solid #e9ecef;
        border-bottom: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 8px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .pedido-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
      }

      .pedido-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        border-color: var(--primary-color);
      }

      .pedido-item-info {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 8px;
        margin-bottom: 0;
        flex-wrap: wrap;
      }

      .pedido-item-info strong {
        color: var(--text-color);
        font-size: 1rem;
        font-weight: 600;
        line-height: 1.3;
      }

      .pedido-item-info small {
        color: var(--text-muted);
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      .pedido-item-info input[type="number"] {
        width: 50px;
        padding: 4px 6px;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        text-align: center;
        font-weight: 500;
        background: white;
        font-size: 0.85rem;
        transition: all 0.3s ease;
      }

      .pedido-item-info input[type="number"]:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(255, 0, 0, 0.1);
        outline: none;
      }

      .pedido-item-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        align-items: center;
        margin-left: auto;
      }

      .pedido-item-actions .btn {
        padding: 4px 8px;
        font-size: 0.8rem;
      }

      .pedido-total {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border: 2px solid var(--primary-color);
        border-radius: 16px;
        padding: 24px;
        margin-top: 24px;
        box-shadow: 0 4px 20px rgba(255, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
      }

      .pedido-total::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color) 0%, var(--primary-hover) 100%);
      }

      .pedido-total-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .pedido-total h3 {
        margin: 0;
        color: var(--text-color);
        font-size: 1.3rem;
        font-weight: 600;
      }

      .pedido-total-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
        text-shadow: 0 2px 4px rgba(255, 0, 0, 0.1);
      }

      .pedido-info-message {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border: 1px solid #ffeaa7;
        border-radius: 12px;
        padding: 16px;
        color: #856404;
        font-size: 0.95rem;
        line-height: 1.5;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);
      }

      .pedido-info-message strong {
        color: #856404;
        font-weight: 600;
      }

      #pedido-vazio {
        text-align: center;
        color: var(--text-muted);
        font-style: italic;
        padding: 40px 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border: 2px dashed #e9ecef;
        border-radius: 12px;
        margin: 0;
      }

      .total-container {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        padding: 20px;
        border-radius: var(--border-radius-lg);
        margin-top: 20px;
        text-align: center;
        border: 2px solid var(--border-color);
      }

      .total-container h3 {
        margin: 0;
        font-size: 1.2rem;
        color: var(--dark-color);
        font-weight: 700;
      }

      #gerar-pedido-btn {
        width: 100%;
        padding: 12px 20px;
        font-size: 1rem;
        font-weight: 600;
        margin-top: 20px;
      }

      #total-pedido {
        color: var(--success-color);
      }

      /* Estilos para cards de produtos mobile */
      .produtos-mobile-container {
        display: none;
        flex-direction: column;
        gap: 15px;
        padding: 10px;
      }

      .produto-card-mobile {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-lg);
        padding: 15px;
        box-shadow: var(--shadow-sm);
        transition: all 0.3s ease;
      }

      .produto-card-mobile:hover {
        box-shadow: var(--shadow);
        transform: translateY(-2px);
      }

      .produto-header-mobile {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border-color);
      }

      .produto-ref-mobile {
        font-weight: 700;
        font-size: 1.1rem;
        color: var(--primary-color);
      }

      .produto-preco-mobile {
        font-weight: 600;
        font-size: 1.2rem;
        color: var(--success-color);
      }

      .produto-descricao-mobile {
        margin-bottom: 15px;
      }

      .produto-descricao-mobile h4 {
        margin: 0 0 5px 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-color);
        line-height: 1.3;
      }

      .produto-quantidade-mobile {
        margin-bottom: 15px;
      }

      .produto-quantidade-mobile label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--text-color);
        font-size: 0.9rem;
      }

      .produto-quantidade-mobile input {
        width: 100%;
        padding: 8px 12px;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        font-size: 0.9rem;
      }

      .btn-adicionar-mobile {
        width: 100%;
        background: var(--gradient-success);
        color: white;
        border: none;
        padding: 12px;
        border-radius: var(--border-radius);
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .btn-adicionar-mobile:hover {
        background: var(--success-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow);
      }

      /* Ocultar tabelas em mobile */
      .table-responsive {
        display: block;
      }

    @media (max-width: 768px) {
      .header-top {
        padding: 15px;
        height: 85px;
        flex-direction: column;
        gap: 10px;
        align-items: center;
        justify-content: center;
      }
      
      .header-left {
        display: flex;
      }
      
      .header-center {
        position: static;
        transform: none;
        order: 1;
      }
      
      .header-center img {
        width: 200px;
        height: auto;
        max-width: 80%;
      }
      
      .header-right {
        order: 2;
        width: 100%;
        justify-content: space-between;
        gap: 8px;
      }
      
      #user-info {
        font-size: 0.75rem;
        flex: 1;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      
      #logout-button, .btn {
        padding: 6px 10px;
        font-size: 0.75rem;
        min-width: auto;
        flex-shrink: 0;
      }

      body {
        padding-top: 80px;
      }

      /* Ocultar tabelas em mobile */
      .table-responsive {
        display: none;
      }

      /* Mostrar container mobile */
      .produtos-mobile-container {
        display: flex;
      }

      /* Ajustar container de produtos */
      #produtos-container {
        max-height: 600px;
        overflow-y: auto;
      }

      /* Ajustar cards */
      .card {
        padding: 15px;
        margin-bottom: 20px;
      }

      .card-header h2 {
        font-size: 1.3rem;
      }
    }

    @media (max-width: 480px) {
      .header-center img {
        width: 150px;
        max-width: 75%;
      }
    }
    </style>
  </head>
  <body class="g8-theme-g8-default">
    <header class="header-top">
      <div class="header-left">
        <div class="status-indicator" id="connection-status">
          <div class="status-dot"></div>
          <span>Online</span>
        </div>
      </div>
      <div class="header-center">
        <img
          id="logo"
          src="https://i.imgur.com/vjq26ym.png"
          alt="Logo G8 BKB"
        />
      </div>
      <div class="header-right">
        <div id="user-info">Carregando...</div>
        <button id="logout-button" onclick="logout()">Sair</button>
        <a href="painel.html" class="btn">‚¨ÖÔ∏è Voltar</a>
      </div>
    </header>

    <main class="container">
      <section class="card">
        <div class="card-header">
          <span
            role="img"
            aria-label="Gerenciar Cliente"
            style="font-size: 1.8em"
            >üë§</span
          >
          <h2>Gerenciar Cliente - BKB</h2>
        </div>
        <div class="form-group">
          <input type="text" id="busca-cliente" placeholder="Buscar cliente..." style="margin-bottom: 10px;" />
          <div id="sugestoes-clientes" style="position: relative; z-index: 10;"></div>
          <select id="cliente-selecionado" style="display: none;">
            <option value="">- Selecione um cliente -</option>
            <option value="novo">- Inserir manualmente -</option>
          </select>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <span
            role="img"
            aria-label="Informa√ß√µes do Cliente"
            style="font-size: 1.8em"
            >üìã</span
          >
          <h2>Informa√ß√µes do Cliente - BKB</h2>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label for="razao"><span>üè¢</span>Raz√£o Social:</label>
            <input type="text" id="razao" placeholder="Raz√£o Social" />
          </div>
          <div class="form-group">
            <label for="cnpj"><span>üè≠</span>CNPJ:</label>
            <input type="text" id="cnpj" placeholder="CNPJ" />
          </div>
          <div class="form-group">
            <label for="ie"><span>üìù</span>I.E:</label>
            <input type="text" id="ie" placeholder="Inscri√ß√£o Estadual" />
          </div>
          <div class="form-group">
            <label for="endereco"><span>üó∫Ô∏è</span>Endere√ßo:</label>
            <input type="text" id="endereco" placeholder="Endere√ßo" />
          </div>
          <div class="form-group">
            <label for="bairro"><span>üèòÔ∏è</span>Bairro:</label>
            <input type="text" id="bairro" placeholder="Bairro" />
          </div>
          <div class="form-group">
            <label for="cidade"><span>üèôÔ∏è</span>Cidade:</label>
            <input type="text" id="cidade" placeholder="Cidade" />
          </div>
          <div class="form-group">
            <label for="estado"><span>üåé</span>Estado:</label>
            <input type="text" id="estado" placeholder="Estado" />
          </div>
          <div class="form-group">
            <label for="cep"><span>üì´</span>CEP:</label>
            <input type="text" id="cep" placeholder="CEP" />
          </div>
          <div class="form-group">
            <label for="email"><span>üìß</span>E-mail:</label>
            <input type="email" id="email" placeholder="E-mail" />
          </div>
          <div class="form-group">
            <label for="telefone"><span>üìû</span>Telefone:</label>
            <input type="text" id="telefone" placeholder="Telefone" />
          </div>
          <div class="form-group">
            <label for="transporte"><span>üöö</span>Transporte:</label>
            <input type="text" id="transporte" placeholder="Transporte" />
          </div>
          <div class="form-group">
            <label for="prazo"><span>üí∞</span>Prazo Pagamento:</label>
            <input type="text" id="prazo" placeholder="Prazo de Pagamento" />
          </div>
          <div class="form-group full-width">
            <label for="obs"><span>üí¨</span>Observa√ß√µes:</label>
            <textarea id="obs" rows="3" placeholder="Observa√ß√µes adicionais"></textarea>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <span role="img" aria-label="Produtos" style="font-size: 1.8em">üì¶</span>
          <h2>Adicionar Produtos ao Pedido</h2>
        </div>
        
        <div class="form-group">
          <input type="text" id="busca-produto" placeholder="Buscar produto por c√≥digo ou descri√ß√£o..." style="margin-bottom: 10px;" />
          <div id="sugestoes-produtos" style="position: relative; z-index: 10;"></div>
        </div>
      </div>
      <div id="produtos-container"></div>
      <section class="card">
        <div class="card-header">
          <span role="img" aria-label="Seu Pedido" style="font-size: 1.8em">üõí</span>
          <h2>Seu Pedido</h2>
        </div>
        <div id="pedido-container">
          <p id="pedido-vazio">Nenhum item adicionado ao pedido ainda.</p>
        </div>
        <div class="total-container">
          <h3>üí∞ Total do Pedido: R$ <span id="total-pedido">0.00</span></h3>
        </div>
        <button id="gerar-pedido-btn" class="btn btn-primary">
          üñ®Ô∏è Gerar Pedido em PDF
        </button>
        <div id="status-mensagem"></div>
      </section>
    </main>
    
    <footer>
      ¬© 2025 J.P Sistemas. Todos os direitos reservados. | <a href="https://whatsa.me/5548996852138/?t=Ol%C3%A1,%20gostaria%20de%20mais%20informa%C3%A7%C3%B5es%20sobre%20os%20sistemas." target="_blank" style="color: #000000; text-decoration: underline;">jp-sistemas.com</a>
    </footer>

    <script>
      let clientesCadastrados = [];
      let produtosSelecionados = [];
      let produtosData = [];
      const produtosContainer = document.getElementById("produtos-container");
      const pedidoContainer = document.getElementById("pedido-container");
      const pedidoVazio = document.getElementById("pedido-vazio");
      
      // Vari√°veis para controle do pedido
      window.pedidoItens = [];
      let subtotalPedido = 0;

      // Inputs do cliente
      const selectCliente = document.getElementById("cliente-selecionado");
      const inputsCliente = {
        razao: document.getElementById("razao"),
        cnpj: document.getElementById("cnpj"),
        ie: document.getElementById("ie"),
        endereco: document.getElementById("endereco"),
        bairro: document.getElementById("bairro"),
        cidade: document.getElementById("cidade"),
        estado: document.getElementById("estado"),
        cep: document.getElementById("cep"),
        email: document.getElementById("email"),
        telefone: document.getElementById("telefone"),
        transporte: document.getElementById("transporte"),
        prazo: document.getElementById("prazo"),
        obs: document.getElementById("obs"),
      };

      // Verificar autentica√ß√£o
      function checkAuth() {
        const loggedInUser = sessionStorage.getItem("loggedInUser");
        if (!loggedInUser) {
          window.location.href = 'index.html';
          return false;
        }
        document.getElementById('user-info').textContent = loggedInUser.charAt(0).toUpperCase() + loggedInUser.slice(1);
        return true;
      }

      // Fun√ß√£o de logout
      function logout() {
        sessionStorage.removeItem("loggedInUser");
        localStorage.removeItem("savedUsername");
        localStorage.removeItem("savedPassword");
        window.location.href = 'index.html';
      }

      // Carregar clientes da API
      async function carregarClientes() {
        try {
          const response = await fetch('/api/clientes');
          if (!response.ok) throw new Error('Erro ao buscar clientes da API');
          const data = await response.json();
          clientesCadastrados = data;
        } catch (error) {
          console.error('Erro ao carregar clientes da API:', error);
          // Fallback para o arquivo JSON se a API falhar
          try {
            const response = await fetch('clientes.json');
            if (!response.ok) throw new Error('Erro ao buscar clientes.json');
            const data = await response.json();
            clientesCadastrados = data;
          } catch (fallbackError) {
            alert('Erro ao carregar os dados dos clientes. Verifique se a API est√° dispon√≠vel.');
          }
        }
      }

      // Popular select de clientes
      async function popularClientes(filtro = "") {
        if (clientesCadastrados.length === 0) {
          await carregarClientes();
        }
        selectCliente.innerHTML = '';
        const optionPadrao = document.createElement("option");
        optionPadrao.value = "";
        optionPadrao.textContent = "- Selecione um cliente -";
        selectCliente.appendChild(optionPadrao);
        const optionNovo = document.createElement("option");
        optionNovo.value = "novo";
        optionNovo.textContent = "- Inserir manualmente -";
        selectCliente.appendChild(optionNovo);
        
        const filtroLower = filtro.toLowerCase();
        const clientesFiltrados = clientesCadastrados.filter((cliente) => {
          return (
            !filtro ||
            (cliente.razao && cliente.razao.toLowerCase().includes(filtroLower)) ||
            (cliente.cnpj && cliente.cnpj.toLowerCase().includes(filtroLower)) ||
            (cliente.cidade && cliente.cidade.toLowerCase().includes(filtroLower))
          );
        });
        
        clientesFiltrados.forEach((cliente) => {
          const option = document.createElement("option");
          option.value = cliente.id;
          option.textContent = `${cliente.razao} - ${cliente.cidade || ""}`;
          selectCliente.appendChild(option);
        });
      }

      // Preencher formul√°rio com dados do cliente
      function preencherFormularioCliente(clienteId) {
        if (clienteId === "novo" || !clienteId) {
          Object.values(inputsCliente).forEach((input) => (input.value = ""));
          return;
        }
        const cliente = clientesCadastrados.find((c) => c.id === clienteId);
        if (cliente) {
          for (const key in inputsCliente) {
            inputsCliente[key].value = cliente[key] || "";
          }
        }
      }

      // Mostrar sugest√µes de clientes
      function mostrarSugestoesClientes(filtro) {
        const sugestoesDiv = document.getElementById("sugestoes-clientes");
        sugestoesDiv.innerHTML = "";
        if (!filtro || filtro.length < 2) {
          sugestoesDiv.style.display = "none";
          return;
        }
        const filtroLower = filtro.toLowerCase();
        const clientesFiltrados = clientesCadastrados.filter((cliente) => {
          return (
            (cliente.razao && cliente.razao.toLowerCase().includes(filtroLower)) ||
            (cliente.cnpj && cliente.cnpj.toLowerCase().includes(filtroLower)) ||
            (cliente.cidade && cliente.cidade.toLowerCase().includes(filtroLower))
          );
        });
        if (clientesFiltrados.length === 0) {
          sugestoesDiv.style.display = "none";
          return;
        }
        sugestoesDiv.style.display = "block";
        clientesFiltrados.slice(0, 8).forEach((cliente) => {
          const item = document.createElement("div");
          item.className = "sugestao-cliente-item";
          item.innerHTML = `<strong>${cliente.razao}</strong><br><small>${cliente.cidade || ""} | CNPJ: ${cliente.cnpj || ""} | Tel: ${cliente.telefone || ""}</small>`;
          item.addEventListener("mousedown", (e) => {
            e.preventDefault();
            selectCliente.value = cliente.id;
            preencherFormularioCliente(cliente.id);
            document.getElementById("busca-cliente").value = cliente.razao;
            sugestoesDiv.style.display = "none";
          });
          sugestoesDiv.appendChild(item);
        });
      }

// ========== IN√çCIO DA LISTA DE PRODUTOS BKB ==========
window.produtosData = [
  { REFERENCIA: "PDL-150", DESCRI√á√ÉO: "BORRACHA ESTRIBO TITAN 125/150", PRECO: 9.00 },
  { REFERENCIA: "PDL-160", DESCRI√á√ÉO: "BORRACHA ESTRIBO TITAN 160", PRECO: 14.00 },
  { REFERENCIA: "PDL-FAC", DESCRI√á√ÉO: "BORRACHA ESTRIBO FACTOR/FAZER 150 (PAR LADO ESQUERDO E DIREITO)", PRECO: 27.50 },
  { REFERENCIA: "CXM-001", DESCRI√á√ÉO: "COXIM COROA TITAN 150", PRECO: 12.00 },
  { REFERENCIA: "CXM-002", DESCRI√á√ÉO: "COXIM COROA TWISTER/CB300", PRECO: 16.00 },
  { REFERENCIA: "CXM-003", DESCRI√á√ÉO: "COXIM FAZR 250", PRECO: 17.00 },
  { REFERENCIA: "CXM-004", DESCRI√á√ÉO: "COXIM COROA FALCO/XRE300/TRANSALP", PRECO: 23.00 },
  { REFERENCIA: "CXM-006", DESCRI√á√ÉO: "COXIM COROA YES/INTRUDER", PRECO: 16.00 },
  { REFERENCIA: "CXM-007", DESCRI√á√ÉO: "COXIM COROA BIZ 100/125", PRECO: 13.00 },
  { REFERENCIA: "CXM-008", DESCRI√á√ÉO: "COXIM COROA FAZER 250 2018/FAZER FZ 15", PRECO: 23.00 },
  { REFERENCIA: "CXM-009", DESCRI√á√ÉO: "COXIM COROA MT-03 2018 EM DIANTE/YZF R3", PRECO: 52.00 },
  { REFERENCIA: "CXM-010", DESCRI√á√ÉO: "COXIM COROA KAWASAKI ER-650/NINJA 650/VERSYS 650/Z650/NINJA ZX-4R", PRECO: 56.00 },
  { REFERENCIA: "CXM-011", DESCRI√á√ÉO: "COXIM COROA CB500F/CB 500X/CBR 500R/CB 600F HORNET/CB 650F/CBR 650F/CB 650R/NC 700X/NC 750X", PRECO: 50.00 },
  { REFERENCIA: "CXM-012", DESCRI√á√ÉO: "COXIM COROA DREAM 100/POP 100/SHINERAY XY 50Q/JET/PHOENIX/TRAXX/STAR 50/MOBY 50/SKY 50-125/WEB 100/DAFRA SUPER 50/SUPER 100/KASINSKI SOFT 50/WIN 110", PRECO: 13.00 },
  { REFERENCIA: "CXM-013", DESCRI√á√ÉO: "COXIM COROA XT 600/XT 660/MT-03/T√âN√âR√â 600/VIRAGO 250", PRECO: 46.00 },
  { REFERENCIA: "CXM-014", DESCRI√á√ÉO: "COXIM COROA KAWASAKI NINJA 250/300", PRECO: 52.00 },
  { REFERENCIA: "CXM-015", DESCRI√á√ÉO: "COXIM COROA SUZUKI GS 500/BANDIT 650", PRECO: 56.00 },
  { REFERENCIA: "GCB-150", DESCRI√á√ÉO: "GUARNI√á√ÉO CARBURADOR TITAN 150/CG 125/KS/XLS/XLR/NX/CBX 200", PRECO: 1.50 },
  { REFERENCIA: "GPB-125", DESCRI√á√ÉO: "GUARDA P√ì BENGALA CG 125/FAN 125/BIZ 125/POP 100", PRECO: 5.00 },
  { REFERENCIA: "GPB-150", DESCRI√á√ÉO: "GUARDA P√ì BENGALA TITAN 150", PRECO: 5.00 },
  { REFERENCIA: "GPB-TW", DESCRI√á√ÉO: "GUARDA P√ì BENGALA TWISTER/CB 300/CB 250F/CB 160F/CBR 250 EXPO", PRECO: 11.50 },
  { REFERENCIA: "GRN-125", DESCRI√á√ÉO: "GUARNI√á√ÉO TAMPA DE V√ÅLVULA TITAN 99/2000", PRECO: 3.00 },
  { REFERENCIA: "GRN-150S", DESCRI√á√ÉO: "GUARNI√á√ÉO TAMPA DE V√ÅLVULA TITAN150(S/RETENTOR)", PRECO: 3.50 },
  { REFERENCIA: "GRN-160", DESCRI√á√ÉO: "GUARNI√á√ÉO TAMPA DE V√ÅLVULA TITAN 160", PRECO: 6.00 },
  { REFERENCIA: "GRN-300", DESCRI√á√ÉO: "GUARNI√á√ÉO TAMPA DE V√ÅLVULA CB300/XRE300", PRECO: 19.00 },
  { REFERENCIA: "GRN-TW", DESCRI√á√ÉO: "GUARNI√á√ÉO TAMPA DE V√ÅLVULA TWISTER/ TORNADO", PRECO: 19.00 },
  { REFERENCIA: "BAM-001", DESCRI√á√ÉO: "KIT BORRACHA AMORTECEDOR TITAN 2000", PRECO: 13.00 },
  { REFERENCIA: "GRN-150", DESCRI√á√ÉO: "KIT GUARNI√á√ÉO TAMPA DE V√ÅLVULA  TITAN 150", PRECO: 11.00 },
  { REFERENCIA: "RPF-001", DESCRI√á√ÉO: "KIT VEDA√á√ÉO PIN√áA DE FREIO PARCIAL TITAN", PRECO: 6.00 },
  { REFERENCIA: "MGC-001", DESCRI√á√ÉO: "MANGUEIRA DE COMBUST√çVEL (METRO)", PRECO: 5.00 },
  { REFERENCIA: "PRB-001", DESCRI√á√ÉO: "PRESILHA DE RABETA 4MM TITAN 150", PRECO: 1.50 },
  { REFERENCIA: "PRB-002", DESCRI√á√ÉO: "PRESILHA DE RABETA 5MM BIZ 100/125", PRECO: 1.50 },
  { REFERENCIA: "RBE-001", DESCRI√á√ÉO: "RETENTOR DE BENGALA CG 150/160/BROSS 150/160 CC - 31 X 43 X 10,5", PRECO: 12.00 },
  { REFERENCIA: "RBE-002", DESCRI√á√ÉO: "RETENTOR DE BENGALA CG 125/BIZ 100/125/POP 10 - 27 X 39 X 10,5", PRECO: 12.00 },
  { REFERENCIA: "RBE-003", DESCRI√á√ÉO: "RETENTOR DE BENGALA YBR/FACTOR/YES/BURGMAN 125 - 30 X 40,5 X 10,5", PRECO: 12.00 },
  { REFERENCIA: "RBE-004", DESCRI√á√ÉO: "RETENTOR DE BENGALA TWISTER/CB 300/CB 500/FAZER 250 - 37 X 50 X 11", PRECO: 15.00 },
  { REFERENCIA: "RTT-001", DESCRI√á√ÉO: "RETENTOR TAMPA DE V√ÅLVULA TITAN/TWISTER/300", PRECO: 2.50 },
];
// ========== FIM DA LISTA DE PRODUTOS BKB ==========

      // Carregar produtos
      function carregarProdutos() {
        produtosData = window.produtosData;
        renderizarProdutos(produtosData);
      }

      // Fun√ß√£o para renderizar produtos
      function renderizarProdutos(produtos = produtosData) {
        if (!produtosContainer) {
          return;
        }
        produtosContainer.innerHTML = "";
        
        // Fun√ß√£o para detectar se √© mobile
        function isMobile() {
          return window.innerWidth <= 768;
        }

        // Fun√ß√£o para gerar card de produto para mobile
        function gerarCardProdutoMobile(produto) {
          return `
            <div class="produto-card-mobile">
              <div class="produto-header-mobile">
                <div class="produto-ref-mobile">${produto.REFERENCIA}</div>
                <div class="produto-preco-mobile">R$ ${produto.PRECO.toFixed(2)}</div>
              </div>
              <div class="produto-descricao-mobile">
                <h4>${produto.DESCRI√á√ÉO}</h4>
              </div>
              <div class="produto-quantidade-mobile">
                <label>Quantidade:</label>
                <input type="number" min="0" value="0" id="quantidade-${produto.REFERENCIA}">
              </div>
              <div class="produto-actions-mobile">
                <button class="btn-adicionar-mobile" onclick='adicionarAoPedido(${JSON.stringify(produto)})'>
                  ‚ûï Adicionar ao Pedido
                </button>
              </div>
            </div>
          `;
        }

        const sectionDiv = document.createElement("section");
        sectionDiv.className = "card";
        
        if (isMobile()) {
          // Layout de cards para mobile
          let cardsHTML = '<div class="card-header"><h2>Produtos BKB</h2></div><div class="produtos-mobile-container">';
          produtos.forEach((produto) => {
            cardsHTML += gerarCardProdutoMobile(produto);
          });
          cardsHTML += '</div>';
          sectionDiv.innerHTML = cardsHTML;
        } else {
          // Layout de tabela para desktop
          let tabelaHTML = '<div class="card-header"><h2>Produtos BKB</h2></div><div class="table-responsive"><table><thead><tr><th>REF.</th><th>DESCRI√á√ÉO</th><th>PRE√áO</th><th>Quantidade</th><th>A√ß√£o</th></tr></thead><tbody>';
          produtos.forEach((produto) => {
            tabelaHTML += `<tr><td style="font-weight: 600;">${produto.REFERENCIA}</td><td>${produto.DESCRI√á√ÉO}</td><td style="font-weight: 600; color: var(--success-color);">R$ ${produto.PRECO.toFixed(2)}</td><td><input type="number" min="0" value="0" id="quantidade-${produto.REFERENCIA}" style="width: 80px; text-align: center;"></td><td><button class="btn btn-success btn-sm" onclick='adicionarAoPedido(${JSON.stringify(produto)})'>Adicionar</button></td></tr>`;
          });
          tabelaHTML += `</tbody></table></div>`;
          sectionDiv.innerHTML = tabelaHTML;
        }
        
        produtosContainer.appendChild(sectionDiv);
      }

      // Fun√ß√£o para adicionar produto ao pedido
      function adicionarAoPedido(produto) {
        const quantidadeInput = document.getElementById(`quantidade-${produto.REFERENCIA}`);
        const quantidade = parseInt(quantidadeInput.value) || 0;
        
        if (quantidade <= 0) {
          alert('Por favor, informe a quantidade do produto.');
          return;
        }

        const itemExistente = window.pedidoItens.find(
          (item) => item.REFERENCIA === produto.REFERENCIA
        );
        
        if (itemExistente) {
          itemExistente.quantidade += quantidade;
        } else {
          window.pedidoItens.push({
            REFERENCIA: produto.REFERENCIA,
            DESCRI√á√ÉO: produto.DESCRI√á√ÉO,
            tamanho: '',  // BKB n√£o usa tamanhos, mas manter compatibilidade
            preco: produto.PRECO,
            quantidade: quantidade,
            descontoExtra: 0
          });
        }
        
        // Resetar quantidade
        quantidadeInput.value = 0;
        
        atualizarVisualizacaoPedido();
      }

      // Fun√ß√£o para alterar quantidade de um item
      function alterarQuantidade(index, novaQuantidade) {
        const quantidade = parseInt(novaQuantidade);
        if (quantidade > 0) {
          window.pedidoItens[index].quantidade = quantidade;
          atualizarVisualizacaoPedido();
        } else {
          removerDoPedido(index);
        }
      }

      // Fun√ß√£o para remover item do pedido
      function removerDoPedido(index) {
        window.pedidoItens.splice(index, 1);
        atualizarVisualizacaoPedido();
      }

      // Fun√ß√£o para atualizar visualiza√ß√£o do pedido
      function atualizarVisualizacaoPedido() {
        pedidoContainer.innerHTML = "";
        subtotalPedido = 0;
        
        if (!Array.isArray(window.pedidoItens)) {
          window.pedidoItens = [];
        }
        
        if (window.pedidoItens.length > 0) {
          pedidoVazio.style.display = "none";
          window.pedidoItens.forEach((item, index) => {
            const itemDiv = document.createElement("div");
            itemDiv.className = "pedido-item";
            const precoTotalItem = item.preco * item.quantidade;
            subtotalPedido += precoTotalItem;
            itemDiv.innerHTML = `
              <div class="pedido-item-info">
                <strong>${item.DESCRI√á√ÉO}</strong>
                <span>Ref: ${item.REFERENCIA}</span>
                <span>‚Ä¢</span>
                <span>Qtd: <input type="number" min="1" value="${item.quantidade}" onchange="alterarQuantidade(${index}, this.value)"></span>
                <span>‚Ä¢</span>
                <span style="font-weight: 600; color: var(--primary-color);">Total: R$ ${precoTotalItem.toFixed(2)}</span>
                <div class="pedido-item-actions">
                  <button class="btn btn-danger" onclick="removerDoPedido(${index})">
                    <span>üóëÔ∏è</span> Remover
                  </button>
                </div>
              </div>
            `;
            pedidoContainer.appendChild(itemDiv);
          });
        } else {
          pedidoVazio.style.display = "block";
        }

        // Atualizar total do pedido
        const totalElement = document.getElementById('total-pedido');
        if (totalElement) {
          totalElement.textContent = subtotalPedido.toFixed(2);
        }
      }

      // Gerar Pedido em PDF e Enviar
      function gerarPedidoPDF() {
        if (window.pedidoItens.length === 0) {
          alert("O pedido est√° vazio. Adicione itens antes de gerar o PDF.");
          return;
        }
        // Valida√ß√£o dos campos obrigat√≥rios
        if (!inputsCliente.transporte.value.trim()) {
          alert("O campo Transporte √© obrigat√≥rio.");
          inputsCliente.transporte.focus();
          return;
        }
        if (!inputsCliente.prazo.value.trim()) {
          alert("O campo Prazo de Pagamento √© obrigat√≥rio.");
          inputsCliente.prazo.focus();
          return;
        }
        if (!inputsCliente.obs.value.trim()) {
          alert("O campo Observa√ß√µes √© obrigat√≥rio.");
          inputsCliente.obs.focus();
          return;
        }

        // Gerar o PDF primeiro
        gerarPDF();

        // Depois enviar o pedido
        setTimeout(() => {
          enviarPedido();
        }, 500);
      }

      // Gerar PDF do pedido
      function gerarPDF() {
        if (window.pedidoItens.length === 0) {
          alert("O pedido est√° vazio. Adicione itens antes de gerar o PDF.");
          return;
        }
        // Valida√ß√£o dos campos obrigat√≥rios
        if (!inputsCliente.transporte.value.trim()) {
          alert("O campo Transporte √© obrigat√≥rio.");
          inputsCliente.transporte.focus();
          return;
        }
        if (!inputsCliente.prazo.value.trim()) {
          alert("O campo Prazo de Pagamento √© obrigat√≥rio.");
          inputsCliente.prazo.focus();
          return;
        }
        if (!inputsCliente.obs.value.trim()) {
          alert("O campo Observa√ß√µes √© obrigat√≥rio.");
          inputsCliente.obs.focus();
          return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF("p", "mm", "a4");
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 15;
        let finalY = 0;

        const drawHeaderAndFooter = (data) => {
          const logoImg = new Image();
          logoImg.src = "https://i.imgur.com/vjq26ym.png";
          doc.addImage(logoImg, "PNG", margin, 10, 90, 15);
          doc.setFontSize(16);
          doc.setFont("helvetica", "bold");
          doc.text("Pedido de Venda - BKB", pageWidth - margin, 18, {
            align: "right",
          });
          const hoje = new Date();
          const dataAtual = `${hoje.getDate().toString().padStart(2, "0")}/${(
            hoje.getMonth() + 1
          )
            .toString()
            .padStart(2, "0")}/${hoje.getFullYear()}`;
          doc.setFontSize(10);
          doc.setFont("helvetica", "normal");
          doc.text(`Data: ${dataAtual}`, pageWidth - margin, 24, {
            align: "right",
          });

          const pageCount = doc.internal.getNumberOfPages();
          doc.setFontSize(8);
          doc.text(
            `P√°gina ${data.pageNumber} de ${pageCount}`,
            pageWidth / 2,
            pageHeight - 10,
            { align: "center" }
          );
        };

        drawHeaderAndFooter({ pageNumber: 1 });

        doc.autoTable({
          startY: 30,
          theme: "grid",
          head: [
            [
              {
                content: "DADOS DO CLIENTE",
                colSpan: 4,
                styles: {
                  halign: "center",
                  fontStyle: "bold",
                  fillColor: [230, 230, 230],
                  textColor: 30,
                },
              },
            ],
          ],
          body: [
            [
              "Cliente:",
              { content: inputsCliente.razao.value || "N/A", colSpan: 3 },
            ],
            [
              "CNPJ:",
              inputsCliente.cnpj.value || "N/A",
              "I.E.:",
              inputsCliente.ie.value || "N/A",
            ],
            [
              "Telefone:",
              inputsCliente.telefone.value || "N/A",
              "E-mail:",
              inputsCliente.email.value || "N/A",
            ],
            [
              "Endere√ßo:",
              {
                content: `${inputsCliente.endereco.value || ""}, ${
                  inputsCliente.bairro.value || ""
                }`,
                colSpan: 3,
              },
            ],
            [
              "Cidade/UF:",
              `${inputsCliente.cidade.value || ""}/${
                inputsCliente.estado.value || ""
              }`,
              "CEP:",
              inputsCliente.cep.value || "",
            ],
          ],
          styles: { fontSize: 8, cellPadding: 1.5 },
          columnStyles: {
            0: { fontStyle: "bold", cellWidth: 22 },
            2: { fontStyle: "bold", cellWidth: 20 },
          },
          margin: { left: margin, right: margin },
        });

        let startY = doc.autoTable.previous.finalY + 7;

        const head = [
          ["Ref.", "Descri√ß√£o", "Qtd", "Unit.", "Total"],
        ];
        const body = window.pedidoItens.map((item) => {
          return [
            item.REFERENCIA,
            item.DESCRI√á√ÉO,
            item.quantidade,
            `R$ ${item.preco.toFixed(2)}`,
            `R$ ${(item.preco * item.quantidade).toFixed(2)}`,
          ];
        });

        doc.autoTable({
          head: head,
          body: body,
          startY: startY,
          theme: "grid",
          styles: {
            fontSize: 8,
            cellPadding: 2,
            overflow: "linebreak",
            valign: "middle",
          },
          headStyles: {
            fillColor: [44, 62, 80],
            textColor: [255, 255, 255],
            fontStyle: "bold",
            halign: "center",
          },
          columnStyles: {
            0: { cellWidth: 25, halign: "center" },
            1: { cellWidth: "auto" },
            2: { cellWidth: 15, halign: "center" },
            3: { cellWidth: 25, halign: "right" },
            4: { cellWidth: 30, halign: "right" },
          },
          didDrawPage: (data) => {
            if (data.pageNumber > 1) {
              drawHeaderAndFooter(data);
            }
          },
          margin: { top: 30, bottom: 15 },
        });

        finalY = doc.autoTable.previous.finalY;

        const obsText = `Transporte: ${
          inputsCliente.transporte.value || "A combinar"
        }\nPrazo: ${
          inputsCliente.prazo.value || "A combinar"
        }\n\nObserva√ß√µes:\n${inputsCliente.obs.value || "Nenhuma."}`;

        const summaryData = [];
        summaryData.push(["", ""]);
        summaryData.push([
          {
            content: "Total do Pedido:",
            styles: { fontStyle: "bold", fontSize: 10 },
          },
          {
            content: `R$ ${subtotalPedido.toFixed(2)}`,
            styles: { fontStyle: "bold", fontSize: 10 },
          },
        ]);

        const finalTableBody = [];
        const leftColumn = {
          content: obsText,
          rowSpan: summaryData.length,
          styles: { valign: "top", fontSize: 9 },
        };

        for (let i = 0; i < summaryData.length; i++) {
          const row = [];
          if (i === 0) row.push(leftColumn);
          row.push(summaryData[i][0]);
          row.push(summaryData[i][1]);
          finalTableBody.push(row);
        }

        doc.autoTable({
          startY: finalY + 8,
          theme: "plain",
          body: finalTableBody,
          margin: { left: margin, right: margin },
          columnStyles: {
            0: { cellWidth: pageWidth / 2 - margin },
            1: { halign: "right", fontStyle: "bold" },
            2: { halign: "right" },
          },
        });

        const nomeArquivo = `G8 Pedido BKB - ${inputsCliente.razao.value.replace(
          /[\s\/]/g,
          "_"
        )} - ${new Date().toLocaleDateString("pt-BR").replace(/\//g, "-")}.pdf`;
        doc.save(nomeArquivo);
      }

      // Enviar pedido
      async function enviarPedido() {
        if (window.pedidoItens.length === 0) {
          alert('Adicione pelo menos um produto ao pedido para enviar.');
          return;
        }

        // Valida√ß√£o dos campos obrigat√≥rios
        if (!inputsCliente.razao.value.trim()) {
          alert('Por favor, informe a Raz√£o Social do cliente.');
          inputsCliente.razao.focus();
          return;
        }
        if (!inputsCliente.transporte.value.trim()) {
          alert("O campo Transporte √© obrigat√≥rio.");
          inputsCliente.transporte.focus();
          return;
        }
        if (!inputsCliente.prazo.value.trim()) {
          alert("O campo Prazo de Pagamento √© obrigat√≥rio.");
          inputsCliente.prazo.focus();
          return;
        }
        if (!inputsCliente.obs.value.trim()) {
          alert("O campo Observa√ß√µes √© obrigat√≥rio.");
          inputsCliente.obs.focus();
          return;
        }

        // Preparar descri√ß√£o do pedido
        const descricaoPedido = `Cliente: ${inputsCliente.razao.value} Itens: ${window.pedidoItens.map(item => item.REFERENCIA + ' x' + item.quantidade).join(', ')} Total: R$ ${subtotalPedido.toFixed(2)}`;
        
        const dadosPedido = {
          cliente: Object.fromEntries(Object.entries(inputsCliente).map(([k, v]) => [k, v.value])),
          itens: window.pedidoItens,
          total: subtotalPedido,
          data: new Date().toISOString(),
          representante: sessionStorage.getItem("loggedInUser") || "N√£o identificado"
        };

        // Verificar se est√° em modo edi√ß√£o
        const urlParams = new URLSearchParams(window.location.search);
        const modoEdicao = urlParams.get('modo') === 'edicao';
        
        if (modoEdicao) {
          console.log('üö´ MODO EDI√á√ÉO DETECTADO - n√£o fazendo POST (usando editor-pedido.js)');
          return; // N√£o fazer POST em modo edi√ß√£o
        }
        
        console.log('üì§ Fazendo POST para criar novo pedido (modo normal)');
        
        // Usar sistema offline
        const orderData = {
          empresa: 'bkb',
          descricao: descricaoPedido,
          dados: dadosPedido
        };

        window.offlineSystem.tryToSendOrder(orderData)
          .then(result => {
            if (result.success) {
              if (result.online) {
                alert('‚úÖ Pedido enviado e salvo com sucesso!');
              } else {
                alert('üì± Sem conex√£o! Pedido salvo localmente e ser√° enviado automaticamente quando a conex√£o retornar.');
              }
              
              // Limpar pedido
              window.pedidoItens = [];
              atualizarVisualizacaoPedido();
              
              // Limpar campos do cliente
              selectCliente.value = "";
              Object.values(inputsCliente).forEach((input) => (input.value = ""));
              
              // Redirecionar para pedidos ap√≥s 1 segundo
              setTimeout(() => {
                window.location.href = 'pedidos.html';
              }, 1000);
            } else {
              alert('‚ùå Erro ao processar o pedido.');
            }
          })
          .catch(error => {
            console.error('Erro no sistema offline:', error);
            alert('‚ùå Erro ao processar o pedido.');
          });
      }

      // Fun√ß√£o para mostrar sugest√µes de produtos
      function mostrarSugestoesProdutos(filtro) {
        const sugestoesDiv = document.getElementById("sugestoes-produtos");
        sugestoesDiv.innerHTML = "";
        if (!filtro || filtro.length < 2) {
          sugestoesDiv.style.display = "none";
          return;
        }
        const filtroLower = filtro.toLowerCase();
        const produtosFiltrados = produtosData.filter((produto) => {
          return (
            (produto.REFERENCIA && String(produto.REFERENCIA).toLowerCase().includes(filtroLower)) ||
            (produto.DESCRI√á√ÉO && String(produto.DESCRI√á√ÉO).toLowerCase().includes(filtroLower))
          );
        });
        if (produtosFiltrados.length === 0) {
          sugestoesDiv.style.display = "none";
          return;
        }
        sugestoesDiv.style.display = "block";
        produtosFiltrados.slice(0, 8).forEach((produto) => {
          const item = document.createElement("div");
          item.className = "sugestao-cliente-item";
          item.innerHTML = `<strong>${produto.REFERENCIA}</strong> - ${produto.DESCRI√á√ÉO} <small style="color: #059669;">R$ ${produto.PRECO.toFixed(2)}</small>`;
          item.addEventListener("mousedown", (e) => {
            e.preventDefault();
            document.getElementById("busca-produto").value = `${produto.REFERENCIA} - ${produto.DESCRI√á√ÉO}`;
            sugestoesDiv.style.display = "none";
            renderizarProdutosFiltrados([produto]);
          });
          sugestoesDiv.appendChild(item);
        });
      }

      // Fun√ß√£o para renderizar produtos filtrados
      function renderizarProdutosFiltrados(produtos) {
        renderizarProdutos(produtos);
      }

      // Inicializar p√°gina
      if (checkAuth()) {
        carregarProdutos();
        
        // Bot√£o Gerar Pedido em PDF
        const gerarPedidoBtn = document.getElementById("gerar-pedido-btn");
        gerarPedidoBtn.addEventListener("click", gerarPedidoPDF);
        
        // Carregar clientes e ativar eventos relacionados
        popularClientes().then(() => {
          selectCliente.addEventListener("change", (e) => preencherFormularioCliente(e.target.value));
          
          // Busca de clientes
          const buscaClienteInput = document.getElementById("busca-cliente");
          buscaClienteInput.addEventListener("input", (e) => {
            popularClientes(e.target.value);
            mostrarSugestoesClientes(e.target.value);
          });
          
          document.addEventListener("mousedown", (event) => {
            const sugestoesDiv = document.getElementById("sugestoes-clientes");
            const buscaInput = document.getElementById("busca-cliente");
            if (!sugestoesDiv.contains(event.target) && event.target !== buscaInput) {
              sugestoesDiv.style.display = "none";
            }
          });
        });
        
        // Busca de produtos
        const buscaProdutoInput = document.getElementById("busca-produto");
        buscaProdutoInput.addEventListener("input", (e) => {
          mostrarSugestoesProdutos(e.target.value);
          if (!e.target.value) {
            renderizarProdutos(window.produtosData);
          }
        });
        document.addEventListener("mousedown", (event) => {
          const sugestoesDiv = document.getElementById("sugestoes-produtos");
          const buscaProdutoInput = document.getElementById("busca-produto");
          if (!sugestoesDiv.contains(event.target) && event.target !== buscaProdutoInput) {
            sugestoesDiv.style.display = "none";
          }
        });

        // Event listener para redimensionamento da janela
        window.addEventListener('resize', () => {
          renderizarProdutos(window.produtosData);
        });
      }
    </script>
    <script src="editor-pedido.js"></script>
  </body>
</html>

