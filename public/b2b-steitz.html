<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>G8 Representações</title>
    <link rel="icon" href="https://i.imgur.com/WveVVY5.png" type="image/png" />
    <link rel="apple-touch-icon" href="https://i.imgur.com/WveVVY5.png" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="modern-design.css">
    <link rel="stylesheet" href="mobile.css">
    <script src="advanced-notifications.js"></script>
    <script src="animations.js"></script>

    <style>
      :root {
        /* === CORES G8 === */
        --g8-red: #ff0000;
        --g8-black: #000000;
        --g8-white: #ffffff;
        
        --primary-color: #ff0000;
        --primary-hover: #cc0000;
        --secondary-color: #000000;
        --success-color: #059669;
        --success-hover: #047857;
        --danger-color: #dc2626;
        --danger-hover: #b91c1c;
        --warning-color: #d97706;
        --warning-hover: #b45309;
        --light-color: #ffffff;
        --dark-color: #000000;
        --text-color: #000000;
        --text-muted: #666666;
        --bg-color: #ffffff;
        --card-bg: #fafafa;
        --border-color: #e0e0e0;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --shadow-red: 0 10px 40px rgba(255, 0, 0, 0.25);
        --border-radius: 8px;
        --border-radius-lg: 12px;
        --border-radius-xl: 16px;
        --gradient-primary: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
        --gradient-secondary: linear-gradient(135deg, #000000 0%, #333333 100%);
        --gradient-success: linear-gradient(135deg, #059669 0%, #047857 100%);
        --gradient-danger: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        --gradient-dark: linear-gradient(135deg, #1e293b 0%, #000000 100%);
        --gradient-bg: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: var(--text-color);
        background: var(--bg-color);
        margin: 0;
        padding: 80px 20px 0 20px;
        font-size: 14px;
        min-height: 100vh;
        position: relative;
        display: flex;
        flex-direction: column;
      }

      /* Fundo animado sutil */
      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: 
          radial-gradient(circle at 20% 80%, rgba(255, 0, 0, 0.05) 0%, transparent 50%),
          radial-gradient(circle at 80% 20%, rgba(0, 0, 0, 0.08) 0%, transparent 50%),
          radial-gradient(circle at 40% 40%, rgba(255, 0, 0, 0.03) 0%, transparent 50%);
        animation: backgroundFloat 25s ease-in-out infinite;
        z-index: -1;
      }

      @keyframes backgroundFloat {
        0%, 100% { transform: translateX(0) translateY(0); }
        50% { transform: translateX(-15px) translateY(15px); }
      }

      /* --- NOVO: HEADER DE USUÁRIO E LOGOUT (Importado do Painel) --- */
      .header-top {
        width: 100%;
        position: absolute;
        top: 0;
        left: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 25px;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        box-shadow: var(--shadow);
        z-index: 1000;
        border-bottom: 1px solid var(--border-color);
        height: 70px;
        box-sizing: border-box;
      }

      .header-left {
        flex: 0 0 auto;
      }

      .header-center {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
      }

      .header-center img {
        height: 45px;
        width: auto;
      }

      .header-right {
        flex: 0 0 auto;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .header-center {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
      }

      .header-center img {
        height: 50px;
        width: auto;
      }

      #user-info {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        font-size: 0.9rem;
        color: var(--text-color);
        font-weight: 500;
      }

      #logout-button, .btn {
        background: var(--gradient-primary);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-sm);
      }

      #logout-button:hover, .btn:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        flex: 1;
      }

      /* Caixa de rolagem para produtos */
      #produtos-container {
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 25px;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow);
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        padding: 12px 0;
        transition: all 0.3s ease;
      }

      #produtos-container:hover {
        box-shadow: var(--shadow-lg);
      }

      /* CSS para hover nas linhas da tabela */
      tbody tr:hover {
        background-color: #f5f5f5;
      }

      /* Espaçamento entre produtos na tabela */
      tbody tr {
        border-bottom: 1px solid #e9ecef;
        height: 50px;
      }

      tbody tr td {
        padding: 12px 8px;
        vertical-align: middle;
      }

      /* CSS para botões */
      .btn {
        display: inline-block;
        padding: 8px 16px;
        margin-bottom: 0;
        font-size: 14px;
        font-weight: 400;
        line-height: 1.42857143;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        cursor: pointer;
        border: 1px solid transparent;
        border-radius: 4px;
        text-decoration: none;
        transition: all 0.3s ease;
      }

      .btn-sm {
        padding: 5px 10px;
        font-size: 12px;
        line-height: 1.5;
        border-radius: 3px;
      }

      .btn-success {
        background-color: var(--success-color);
        color: white;
        border-color: var(--success-color);
      }

      .btn-success:hover {
        background-color: var(--success-hover);
        border-color: var(--success-hover);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .btn-danger {
        background-color: var(--danger-color);
        color: white;
        border-color: var(--danger-color);
        padding: 5px 10px;
        font-size: 0.85em;
      }

      .btn-danger:hover {
        background-color: var(--danger-hover);
        border-color: var(--danger-hover);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .card {
        background: var(--card-bg);
        border-radius: var(--border-radius-lg);
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
      }

      .card:hover {
        box-shadow: var(--shadow-lg);
      }

      .card-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--border-color);
      }

      .card-header h2 {
        color: var(--text-color);
        font-size: 1.5rem;
        font-weight: 600;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        margin-bottom: 12px;
      }

      .form-grid .form-group {
        margin-bottom: 0;
      }

      .form-group.full-width {
        grid-column: 1 / -1;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: var(--text-color);
      }

      .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        font-size: 14px;
        transition: all 0.3s ease;
        background: white;
      }

      .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(255, 0, 0, 0.1);
      }

      .btn-primary {
        background: var(--gradient-primary);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary:hover {
        background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      /* Rodapé G8 */
      footer {
        width: 100%;
        text-align: center;
        padding: 15px 20px;
        background: var(--gradient-secondary);
        color: white;
        margin-top: 40px;
        position: relative;
      }

      footer a {
        color: #ff6666;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      footer a:hover {
        color: #ff9999;
        text-decoration: underline;
        text-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
      }

      /* CSS para sugestões de produtos */
      #sugestoes-produtos {
        position: absolute;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-height: 300px;
        overflow-y: auto;
        width: 100%;
        z-index: 1001;
        margin-top: 2px;
        padding: 0;
        display: none;
      }
      .sugestao-cliente-item {
        padding: 10px 16px;
        cursor: pointer;
        font-size: 1em;
        background: #fff;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.18s;
        color: #222;
        line-height: 1.3;
        display: block;
      }
      .sugestao-cliente-item:last-child {
        border-bottom: none;
      }
      .sugestao-cliente-item:hover {
        background: #f3f7fa;
        color: #007bff;
      }

      /* CSS para layout de tamanhos igual ao original */
      .tamanho-input-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }

      .tamanho-input-container > div {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .tamanho-input-container label {
        font-size: 0.75em;
        font-weight: 500;
      }

      .tamanho-input-container input[type="number"] {
        width: 45px;
        padding: 4px;
        text-align: center;
      }

      .manual-tamanho-input {
        width: 140px;
      }

      /* Estilos específicos para inputs em tabelas - igual ao original */
      input[type="text"],
      input[type="number"],
      input[type="email"],
      select,
      textarea {
        width: 100%;
        padding: 10px 12px;
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        font-size: 0.9rem;
        transition: all 0.3s ease;
        background: var(--card-bg);
        color: var(--text-color);
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        transform: translateY(-1px);
      }

      input::placeholder,
      textarea::placeholder {
        color: var(--text-muted);
        font-weight: 400;
      }

      /* Estilos profissionais para seção "Seu Pedido" */
      .pedido-item {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: 1px solid #e9ecef;
        border-bottom: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 8px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
      }

      .pedido-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
      }

      .pedido-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        border-color: var(--primary-color);
      }

      .pedido-item-info {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 8px;
        margin-bottom: 0;
        flex-wrap: wrap;
      }

      .pedido-item-info strong {
        color: var(--text-color);
        font-size: 1rem;
        font-weight: 600;
        line-height: 1.3;
      }

      .pedido-item-info small {
        color: var(--text-muted);
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      .pedido-item-info input[type="number"] {
        width: 50px;
        padding: 4px 6px;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        text-align: center;
        font-weight: 500;
        background: white;
        font-size: 0.85rem;
        transition: all 0.3s ease;
      }

      .pedido-item-info input[type="number"]:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(255, 0, 0, 0.1);
        outline: none;
      }

      .pedido-item-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        align-items: center;
        margin-left: auto;
      }

      .pedido-item-actions .btn {
        padding: 4px 8px;
        font-size: 0.8rem;
      }

      .pedido-total {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border: 2px solid var(--primary-color);
        border-radius: 16px;
        padding: 24px;
        margin-top: 24px;
        box-shadow: 0 4px 20px rgba(255, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
      }

      .pedido-total::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color) 0%, var(--primary-hover) 100%);
      }

      .pedido-total-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .pedido-total h3 {
        margin: 0;
        color: var(--text-color);
        font-size: 1.3rem;
        font-weight: 600;
      }

      .pedido-total-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
        text-shadow: 0 2px 4px rgba(255, 0, 0, 0.1);
      }

      .pedido-info-message {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border: 1px solid #ffeaa7;
        border-radius: 12px;
        padding: 16px;
        color: #856404;
        font-size: 0.95rem;
        line-height: 1.5;
        display: flex;
        align-items: flex-start;
        gap: 12px;
        box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);
      }

      .pedido-info-message strong {
        color: #856404;
        font-weight: 600;
      }

      #pedido-vazio {
        text-align: center;
        color: var(--text-muted);
        font-style: italic;
        padding: 40px 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border: 2px dashed #e9ecef;
        border-radius: 12px;
        margin: 0;
      }

      @media (max-width: 768px) {
        .header-top {
          padding: 10px 15px;
          gap: 10px;
        }
        
        .header-center img {
          height: 40px;
        }
        
        #user-info {
          font-size: 0.8rem;
        }
        
        #logout-button, .btn {
          padding: 6px 12px;
          font-size: 0.8rem;
        }
      }
    </style>
  </head>
  <body class="g8-theme-g8-default">
    <header class="header-top">
      <div class="header-left"></div>
      <div class="header-center">
        <img
          id="logo"
          src="https://i.imgur.com/vjq26ym.png"
          alt="Logo G8 Steitz"
        />
      </div>
      <div class="header-right">
        <div id="user-info">Carregando...</div>
        <button id="logout-button" onclick="logout()">Sair</button>
        <a href="b2b-pedidos.html" class="btn">⬅️ Voltar</a>
      </div>
    </header>

    <main class="container">
      <section class="card">
        <div class="card-header">
          <span role="img" aria-label="Cliente" style="font-size: 1.8em">👤</span>
          <h2>Informações do Cliente - Steitz</h2>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label for="razao"><span>🏢</span>Razão Social:</label>
            <input type="text" id="razao" readonly />
          </div>
          <div class="form-group">
            <label for="cnpj"><span>🏭</span>CNPJ:</label>
            <input type="text" id="cnpj" readonly />
          </div>
          <div class="form-group">
            <label for="ie"><span>📝</span>I.E:</label>
            <input type="text" id="ie" readonly />
          </div>
          <div class="form-group">
            <label for="endereco"><span>🗺️</span>Endereço:</label>
            <input type="text" id="endereco" readonly />
          </div>
          <div class="form-group">
            <label for="bairro"><span>🏘️</span>Bairro:</label>
            <input type="text" id="bairro" readonly />
          </div>
          <div class="form-group">
            <label for="cidade"><span>🏙️</span>Cidade:</label>
            <input type="text" id="cidade" readonly />
          </div>
          <div class="form-group">
            <label for="estado"><span>🌎</span>Estado:</label>
            <input type="text" id="estado" readonly />
          </div>
          <div class="form-group">
            <label for="cep"><span>📫</span>CEP:</label>
            <input type="text" id="cep" readonly />
          </div>
          <div class="form-group">
            <label for="email"><span>📧</span>E-mail:</label>
            <input type="email" id="email" readonly />
          </div>
          <div class="form-group">
            <label for="telefone"><span>📞</span>Telefone:</label>
            <input type="text" id="telefone" readonly />
          </div>
          <div class="form-group">
            <label for="transporte"><span>🚚</span>Transporte:</label>
            <input type="text" id="transporte" readonly />
          </div>
          <div class="form-group">
            <label for="prazo"><span>💰</span>Prazo Pagamento:</label>
            <input type="text" id="prazo" readonly />
          </div>
          <div class="form-group full-width">
            <label for="obs"><span>💬</span>Observações:</label>
            <textarea id="obs" rows="3" readonly></textarea>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <span role="img" aria-label="Produtos" style="font-size: 1.8em">📦</span>
          <h2>Adicionar Produtos ao Pedido</h2>
        </div>
        
        <div class="form-group">
          <label for="busca-produto">Buscar Produto:</label>
          <input type="text" id="busca-produto" placeholder="Digite o nome, referência ou código do produto..." />
          <div id="sugestoes-produtos"></div>
        </div>
      </div>
      
      <div id="produtos-container"></div>
      
      <section class="card">
        <div class="card-header">
          <span role="img" aria-label="Seu Pedido" style="font-size: 1.8em">🛒</span>
          <h2>Seu Pedido</h2>
        </div>
        
        <div id="produtos-selecionados" class="produtos-container">
          <!-- Produtos selecionados aparecerão aqui -->
        </div>

      </section>

      <section class="card">
        <div class="card-header">
          <span role="img" aria-label="Status" style="font-size: 1.8em">📊</span>
          <h2>Status do Pedido</h2>
        </div>
        <div id="status-mensagem">Pronto para adicionar produtos...</div>
      </section>
    </main>
    
    <footer>
      © 2025 J.P. Sistemas. Todos os direitos reservados. | <a href="https://whatsa.me/5548996852138/?t=Ol%C3%A1,%20gostaria%20de%20mais%20informa%C3%A7%C3%B5es%20sobre%20os%20sistemas." target="_blank">jp-sistemas.com</a>
    </footer>

    <script>
      let clienteData = null;
      let produtosSelecionados = [];
      let produtosData = []; // Será carregado do arquivo original
      const produtosContainer = document.getElementById("produtos-container");
      const pedidoContainer = document.getElementById("pedido-container");
      const pedidoVazio = document.getElementById("pedido-vazio");
      
      // Variáveis para controle do pedido
      window.pedidoItens = [];
      let subtotalPedido = 0;

      // Verificar autenticação B2B
      function checkAuthB2B() {
        const clienteStr = localStorage.getItem('clienteB2B');
        if (!clienteStr) {
          window.location.href = 'b2b-login.html';
          return false;
        }
        
        clienteData = JSON.parse(clienteStr);
        
        // Verificar se tem acesso ao Steitz
        if (!clienteData.acessos || !clienteData.acessos.steitz) {
          alert('Você não tem acesso a esta tabela.');
          window.location.href = 'b2b-pedidos.html';
          return false;
        }
        
        return true;
      }

      // Função de logout
      function logout() {
        localStorage.removeItem('clienteB2B');
        localStorage.removeItem('savedCnpjB2B');
        localStorage.removeItem('savedPasswordB2B');
        window.location.href = 'b2b-login.html';
      }

      // Preencher informações do cliente
      function preencherInformacoesCliente() {
        if (!clienteData) return;

        document.getElementById('user-info').textContent = clienteData.razao;
        document.getElementById('razao').value = clienteData.razao || '';
        document.getElementById('cnpj').value = clienteData.cnpj || '';
        document.getElementById('ie').value = clienteData.ie || '';
        document.getElementById('endereco').value = clienteData.endereco || '';
        document.getElementById('bairro').value = clienteData.bairro || '';
        document.getElementById('cidade').value = clienteData.cidade || '';
        document.getElementById('estado').value = clienteData.estado || '';
        document.getElementById('cep').value = clienteData.cep || '';
        document.getElementById('email').value = clienteData.email || '';
        document.getElementById('telefone').value = clienteData.telefone || '';
        document.getElementById('transporte').value = clienteData.transporte || '';
        document.getElementById('prazo').value = clienteData.prazo || '';
        // Preencher observações automaticamente com a empresa
        document.getElementById('obs').value = 'Pedido via B2B - Tabela Steitz';
      }

      // ========== INÍCIO DA LISTA DE PRODUTOS ATUALIZADA ==========
      window.produtosData = [
        {
          CATEGORIA: "Calçados",
          REFERENCIA: "ST001",
          DESCRIÇÃO: "BOTA DE SEGURANÇA STEITZ",
          TAMANHOS: ["35", "36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46"],
          PRECO: 285.50,
        },
        {
          CATEGORIA: "Calçados",
          REFERENCIA: "ST002",
          DESCRIÇÃO: "SAPATO DE SEGURANÇA STEITZ",
          TAMANHOS: ["35", "36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46"],
          PRECO: 245.75,
        },
        {
          CATEGORIA: "Calçados",
          REFERENCIA: "ST003",
          DESCRIÇÃO: "TÊNIS DE SEGURANÇA STEITZ",
          TAMANHOS: ["35", "36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46"],
          PRECO: 195.90,
        },
      ];
      // ========== FIM DA LISTA DE PRODUTOS ATUALIZADA ==========

      // Carregar produtos
      function carregarProdutos() {
        produtosData = window.produtosData;
        console.log('Produtos carregados:', produtosData.length);
        // Renderizar produtos após carregar
        renderizarProdutosPorCategoria(produtosData);
      }

      // Função para renderizar produtos por categoria
      function renderizarProdutosPorCategoria(produtos = produtosData) {
        console.log('Renderizando produtos:', produtos.length, 'produtos');
        if (!produtosContainer) {
          console.error('Elemento produtos-container não encontrado!');
          return;
        }
        produtosContainer.innerHTML = "";
        const categoriasOrdenadas = ["Calçados", "Acessórios"];
        const categoriasAgrupadas = produtos.reduce((acc, produto) => {
          acc[produto.CATEGORIA] = acc[produto.CATEGORIA] || [];
          acc[produto.CATEGORIA].push(produto);
          return acc;
        }, {});
        categoriasOrdenadas.forEach((categoria) => {
          const categoriaProdutos = categoriasAgrupadas[categoria];
          if (!categoriaProdutos || categoriaProdutos.length === 0) return;
          const categoriaDiv = document.createElement("section");
          categoriaDiv.className = "card";
          let tabelaHTML = `<div class="card-header"><h2>${categoria}</h2></div><div class="table-responsive"><table><thead><tr><th>REF.</th><th>DESCRIÇÃO</th><th>PREÇO</th><th>Tamanhos & Quantidades</th><th>Cor</th><th>Ação</th></tr></thead><tbody>`;
          categoriaProdutos.forEach((produto) => {
            const tamanhosNormais = true; // Para Steitz, todos os produtos têm tamanhos normais
            let tamanhosInputHTML = '<div class="tamanho-input-container">';
            const tamanhosProduto = Array.isArray(produto.TAMANHOS) ? produto.TAMANHOS : [produto.TAMANHOS];
            tamanhosProduto.forEach((tamanho) => {
              const tamanhoId = tamanho.replace(/[^a-zA-Z0-9]/g, "");
              tamanhosInputHTML += `<div><label for="quantidade-${produto.REFERENCIA}-${tamanhoId}">${tamanho}</label><input type="number" min="0" value="0" id="quantidade-${produto.REFERENCIA}-${tamanhoId}"></div>`;
            });
            tamanhosInputHTML += "</div>";
            tabelaHTML += `<tr><td>${produto.REFERENCIA}</td><td>${produto.DESCRIÇÃO}<br><small style="color: #6c757d;">${Array.isArray(produto.TAMANHOS) ? produto.TAMANHOS.join(" / ") : produto.TAMANHOS}</small></td><td>R$ ${produto.PRECO.toFixed(2)}</td><td>${tamanhosInputHTML}</td><td><input type="text" placeholder="Opcional" id="cor-${produto.REFERENCIA}" style="width: 100px;"></td><td><button class="btn btn-success btn-sm" onclick='adicionarAoPedido(${JSON.stringify(produto)})'>Adicionar</button></td></tr>`;
          });
          tabelaHTML += `</tbody></table></div>`;
          categoriaDiv.innerHTML = tabelaHTML;
          produtosContainer.appendChild(categoriaDiv);
        });
      }

      // Função para adicionar produto ao pedido
      function adicionarAoPedido(produto) {
        const corSelecionada = document
          .getElementById(`cor-${produto.REFERENCIA}`)
          .value.trim();
        let itemAdicionado = false;
        const handleItem = (tamanho, quantidade) => {
          if (quantidade <= 0) return;
          itemAdicionado = true;
          let precoFinal = produto.PRECO;
          let itemDesc = tamanho;
          if (corSelecionada) itemDesc += `, Cor: ${corSelecionada}`;
          const itemExistente = window.pedidoItens.find(
            (item) =>
              item.REFERENCIA === produto.REFERENCIA &&
              item.tamanho === itemDesc &&
              item.preco === precoFinal
          );
          if (itemExistente) {
            itemExistente.quantidade += quantidade;
          } else {
            window.pedidoItens.push({
              REFERENCIA: produto.REFERENCIA,
              DESCRIÇÃO: produto.DESCRIÇÃO,
              tamanho: itemDesc,
              preco: precoFinal,
              quantidade: quantidade,
            });
          }
        };
        const tamanhosProduto = Array.isArray(produto.TAMANHOS)
          ? produto.TAMANHOS
          : [produto.TAMANHOS];
        tamanhosProduto.forEach((tamanho) => {
          const tamanhoId = tamanho.replace(/[^a-zA-Z0-9]/g, "");
          const quantidade =
            parseInt(
              document.getElementById(
                `quantidade-${produto.REFERENCIA}-${tamanhoId}`
              ).value
            ) || 0;
          handleItem(tamanho, quantidade);
        });
        if (itemAdicionado) {
          atualizarVisualizacaoPedido();
        } else {
          alert(
            `Por favor, informe a quantidade para pelo menos um tamanho do produto ${produto.DESCRIÇÃO}.`
          );
        }
      }

      // Função para alterar quantidade de um item
      function alterarQuantidade(index, novaQuantidade) {
        const quantidade = parseInt(novaQuantidade);
        if (quantidade > 0) {
          window.pedidoItens[index].quantidade = quantidade;
          atualizarVisualizacaoPedido();
        } else {
          // Se quantidade for 0 ou menor, remover o item
          removerDoPedido(index);
        }
      }

      // Função para remover item do pedido
      function removerDoPedido(index) {
        window.pedidoItens.splice(index, 1);
        atualizarVisualizacaoPedido();
      }

      // Função para atualizar visualização do pedido
      function atualizarVisualizacaoPedido() {
        pedidoContainer.innerHTML = "";
        subtotalPedido = 0;
        // Garante que window.pedidoItens sempre seja um array
        if (!Array.isArray(window.pedidoItens)) {
          window.pedidoItens = [];
        }
        if (window.pedidoItens.length > 0) {
          pedidoVazio.style.display = "none";
          window.pedidoItens.forEach((item, index) => {
            const itemDiv = document.createElement("div");
            itemDiv.className = "pedido-item";
            const precoTotalItem = item.preco * item.quantidade;
            subtotalPedido += precoTotalItem;
            itemDiv.innerHTML = `
              <div class="pedido-item-info">
                <strong>${item.DESCRIÇÃO}</strong>
                <span>Ref: ${item.REFERENCIA}</span>
                <span>•</span>
                <span>${item.tamanho}</span>
                <span>•</span>
                <span>Qtd: <input type="number" min="1" value="${item.quantidade}" onchange="alterarQuantidade(${index}, this.value)"></span>
                <span>•</span>
                <span style="font-weight: 600; color: var(--primary-color);">Total: R$ ${precoTotalItem.toFixed(2)}</span>
                <div class="pedido-item-actions">
                  <button class="btn btn-danger" onclick="removerDoPedido(${index})">
                    <span>🗑️</span> Remover
                  </button>
                </div>
              </div>
            `;
            pedidoContainer.appendChild(itemDiv);
          });
        } else {
          pedidoVazio.style.display = "block";
        }

        // Mostrar total do pedido
        if (window.pedidoItens.length > 0) {
          const totalDiv = document.createElement("div");
          totalDiv.className = "pedido-total";
          totalDiv.innerHTML = `
            <div class="pedido-total-header">
              <h3>Total do Pedido:</h3>
              <span class="pedido-total-value">R$ ${subtotalPedido.toFixed(2)}</span>
            </div>
            <div class="pedido-info-message">
              <span style="font-size: 1.2em;">ℹ️</span>
              <div>
                <strong>Informação:</strong> Consulte descontos com o representante. Eles serão aplicados internamente no processamento do pedido.
              </div>
            </div>
            <div style="margin-top: 20px; text-align: center;">
              <button type="button" class="btn-primary" onclick="enviarPedido()" style="padding: 12px 24px; font-size: 1rem; width: 100%; max-width: 300px;">
                📤 Enviar Pedido
              </button>
            </div>
          `;
          pedidoContainer.appendChild(totalDiv);
        }
      }

      // Enviar pedido para o sistema principal
      async function enviarPedido() {
        if (window.pedidoItens.length === 0) {
          alert('Adicione pelo menos um produto ao pedido para enviar.');
          return;
        }

        try {
          // Preparar dados do pedido no formato que a API principal espera
          const pedidoData = {
            empresa: 'b2b-steitz',
            descricao: `Pedido B2B - Steitz - ${window.pedidoItens.length} itens`,
            dados: {
              cliente: clienteData,
              itens: window.pedidoItens,
              total: subtotalPedido,
              data: new Date().toISOString(),
              origem: 'B2B - Steitz',
              transporte: document.getElementById('transporte') ? document.getElementById('transporte').value : '',
              prazo: document.getElementById('prazo') ? document.getElementById('prazo').value : '',
              observacoes: document.getElementById('obs') ? document.getElementById('obs').value : ''
            }
          };

          // Enviar para a API principal
          const response = await fetch('/api/pedidos', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(pedidoData)
          });

          if (response.ok) {
            alert('Pedido enviado com sucesso! Você será redirecionado para seus pedidos.');
            // Limpar pedido local
            window.pedidoItens = [];
            atualizarVisualizacaoPedido();
            // Redirecionar para a página de pedidos B2B
            window.location.href = 'b2b-pedidos.html';
          } else {
            throw new Error('Erro ao enviar pedido');
          }
        } catch (error) {
          console.error('Erro ao enviar pedido:', error);
          alert('Erro ao enviar pedido. Tente novamente.');
        }
      }


      // Função para mostrar sugestões de produtos
      function mostrarSugestoesProdutos(filtro) {
        const sugestoesDiv = document.getElementById("sugestoes-produtos");
        sugestoesDiv.innerHTML = "";
        if (!filtro || filtro.length < 2) {
          sugestoesDiv.style.display = "none";
          return;
        }
        const filtroLower = filtro.toLowerCase();
        const produtosFiltrados = produtosData.filter((produto) => {
          return (
            (produto.REFERENCIA && String(produto.REFERENCIA).toLowerCase().includes(filtroLower)) ||
            (produto.DESCRIÇÃO && String(produto.DESCRIÇÃO).toLowerCase().includes(filtroLower))
          );
        });
        if (produtosFiltrados.length === 0) {
          sugestoesDiv.style.display = "none";
          return;
        }
        sugestoesDiv.style.display = "block";
        produtosFiltrados.slice(0, 8).forEach((produto) => {
          const item = document.createElement("div");
          item.className = "sugestao-cliente-item";
          item.innerHTML = `<strong>${produto.REFERENCIA}</strong> - ${produto.DESCRIÇÃO}`;
          item.addEventListener("mousedown", (e) => {
            e.preventDefault();
            document.getElementById("busca-produto").value = `${produto.REFERENCIA} - ${produto.DESCRIÇÃO}`;
            sugestoesDiv.style.display = "none";
            renderizarProdutosFiltrados([produto]);
          });
          sugestoesDiv.appendChild(item);
        });
      }

      // Função para renderizar produtos filtrados (ou todos)
      function renderizarProdutosFiltrados(produtos) {
        produtosContainer.innerHTML = "";
        // Agrupa por categoria se vier mais de um produto, senão mostra só o produto
        if (produtos.length === 1) {
          const produto = produtos[0];
          const categoriaDiv = document.createElement("section");
          categoriaDiv.className = "card";
          let tabelaHTML = `<div class="card-header"><h2>${produto.CATEGORIA}</h2></div><div class="table-responsive"><table><thead><tr><th>REF.</th><th>DESCRIÇÃO</th><th>PREÇO</th><th>Desc. Extra</th><th>Tamanhos & Quantidades</th><th>Cor</th><th>Ação</th></tr></thead><tbody>`;
          let tamanhosInputHTML = '<div class="tamanho-input-container">';
          const tamanhosProduto = Array.isArray(produto.TAMANHOS) ? produto.TAMANHOS : [produto.TAMANHOS];
          tamanhosProduto.forEach((tamanho) => {
            const tamanhoId = tamanho.replace(/[^a-zA-Z0-9]/g, "");
            tamanhosInputHTML += `<div><label for="quantidade-${produto.REFERENCIA}-${tamanhoId}">${tamanho}</label><input type="number" min="0" value="0" id="quantidade-${produto.REFERENCIA}-${tamanhoId}"></div>`;
          });
          tamanhosInputHTML += "</div>";
          tabelaHTML += `<tr><td>${produto.REFERENCIA}</td><td>${produto.DESCRIÇÃO}<br><small style="color: #6c757d;">${Array.isArray(produto.TAMANHOS) ? produto.TAMANHOS.join(" / ") : produto.TAMANHOS}</small></td><td>R$ ${produto.PRECO.toFixed(2)}</td><td><input type="number" min="0" value="0" class="desconto-input" id="desconto-${produto.REFERENCIA}" style="width: 70px;"></td><td>${tamanhosInputHTML}</td><td><input type="text" placeholder="Opcional" id="cor-${produto.REFERENCIA}" style="width: 100px;"></td><td><button class="btn btn-success btn-sm" onclick='adicionarAoPedido(${JSON.stringify(produto)})'>Adicionar</button></td></tr>`;
          tabelaHTML += `</tbody></table></div>`;
          categoriaDiv.innerHTML = tabelaHTML;
          produtosContainer.appendChild(categoriaDiv);
        } else {
          renderizarProdutosPorCategoria(produtos);
        }
      }

      // Inicializar página
      if (checkAuthB2B()) {
        preencherInformacoesCliente();
        carregarProdutos();
        
        // Busca de produtos
        const buscaProdutoInput = document.getElementById("busca-produto");
        buscaProdutoInput.addEventListener("input", (e) => {
          mostrarSugestoesProdutos(e.target.value);
          if (!e.target.value) {
            renderizarProdutosPorCategoria(window.produtosData);
          }
        });
        document.addEventListener("mousedown", (event) => {
          const sugestoesDiv = document.getElementById("sugestoes-produtos");
          const buscaProdutoInput = document.getElementById("busca-produto");
          if (!sugestoesDiv.contains(event.target) && event.target !== buscaProdutoInput) {
            sugestoesDiv.style.display = "none";
          }
        });
      }
    </script>
  </body>
</html>
